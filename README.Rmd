---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
# Personalized Angle (PAN) regression

This tutorial describes the installation of the R package panreg, and the data analysis using the personalized angle regression described in Hellton (2022), *Penalized angular regression for personalized predictions*. The R package is still under development, and this represents the first working version. 

## Installation
First, you need to install the panreg package from GitHub respository of khellton, using the following code: 
```{r gh-installation, eval = FALSE}
# install.packages("devtools")
devtools::install_github("khellton/panreg")

```

Then load the data and functions used for the analysis. 
```{r}

# Load the R package
library(panreg)

# Load the data (available from https://web.stanford.edu/~hastie/ElemStatLearn/data.html)
data.raw <- read.table(file = 'data/prostate.data')

# Divide the data in test and traning set with approximately 2/3 and 1/3 in each
train.index <- rep(FALSE,dim(data.raw)[1])
train.index[sample(dim(data.raw)[1], 32)] <- TRUE

Y.train <- scale(data.raw$lpsa[train.index],center=TRUE,scale = TRUE)
X.train <- scale(data.matrix(data.raw)[train.index,1:8],center=TRUE,scale = TRUE)
n <- length(Y.train)
n #32 observations in the training set

# Use the scaling from training data
Y.test <- scale(data.raw$lpsa[!train.index],
                center= attr(Y.train,"scaled:center"),
                scale = attr(Y.train,"scaled:scale"))

X.test <- scale(data.matrix(data.raw)[!train.index,1:8],
                center= attr(X.train,"scaled:center"),
                scale = attr(X.train,"scaled:scale"))

n.test <- length(Y.test)
n.test #65 observations in the training set

```

# Analysis and prediction error

```{r}

# Run bootstrap procedure to determine tuning parameter with 2000 bootstrap samples
PAN.bootstrap <- PAN.bootstrap(X.train = X.train, Y.train = Y.train,
                               bootstrap.samples = 500,
                               lambdaMax = 5, stepSize = 0.05,
                               lambdaMaxNeg = 5,stepSizeNeg = 0.25)
head(PAN.bootstrap)

# Plot the MSE tuning curve
plot(PAN.bootstrap$lambdas,PAN.bootstrap$MSE,
     main = 'Bootstrap mean squared error',
     xlab = 'Tuning parameter', ylab = 'MSE')
abline(v=PAN.bootstrap$lambda.min)

# Predict for the test set using PAN
PAN.predictions.path <- PAN(X.train = X.train, Y.train = Y.train, 
                            X.test = X.test, 
                            lambdaMax = PAN.bootstrap$lambda.min, stepSize = 0.005)

# Use the PAN prediction for the last tuning parameter value
PAN.predictions <- PAN.predictions.path$preditions[,length(PAN.predictions.path$lambdas)] 

beta.ols <- solve(t(X.train)%*%X.train)%*%t(X.train)%*%Y.train
gamma0 <- beta.ols/norm(beta.ols)

# Predict for the test set using OLS regression
OLS.predictions <-  c(X.test %*% beta.ols)

# Compute the mean squared error on test set
mean(( Y.test - c(X.test %*% beta.ols))^2)
mean(( Y.test - PAN.predictions)^2)

```
